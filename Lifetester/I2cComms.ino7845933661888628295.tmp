/*
function that executes whenever data is requested by master
this function is registered as an event, see setup()
all other code is interrupted and the data sent to master 
send data as a sequence of 14 bytes...

MSB/LSB(v_a) MSB/LSB(i_a) MSB/LSB(v_b) MSB/LSB(i_b)
MSB/LSB(T) MSB/LSB(intensity)error_A error B

TO DO: buffer readings and transmit everything using termination byte.
*/

void I2C_TransmitData(void)
{
  Wire.write(I2CData, 14);  
}

void I2C_PackI32(uint8_t packArray[], uint32_t data, uint16_t index)
{ 
  uint16_t i;
  uint16_t j;
  for (i = index, j = 3; i < 4; i++, j--)
  {
    packArray[i] = data >> (j * 8);
  }
}

void I2C_PackI16(uint8_t packArray[], uint16_t data, uint16_t index)
{ 
  packArray[index] = data >> 8;
  packArray[index++] = data;
}

void I2C_PrepareData(uint8_t data[])
{
  uint16_t Temp = TSense.raw_data;
  uint16_t Intensity = analogRead(LdrPin);
  uint32_t tTransmit = 0.5 * (LTChannelA.timer + LTChannelB.timer);

  I2C_PackI32(I2CData, tTransmit, 0);
  I2C_PackI16(T2CData, LTChannelA.IVData.v, 4);
  I2C_PackI16(T2CData, LTChannelA.IVData.iTransmit, 6);
  I2C_PackI16(T2CData, LTChannelB.IVData.v, 8);
  I2C_PackI16(T2CData, LTChannelA.IVData.iTransmit, 10);
  I2C_PackI16(T2CData, Temp, 12);
  I2C_PackI16(T2CData, Intensity, 14);
  I2CData[16] = LTChannelA.error;
  I2CData[17] = LTChannelB.error;
}
