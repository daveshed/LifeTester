/*
function that executes whenever data is requested by master
this function is registered as an event, see setup()
all other code is interrupted and the data sent to master 
send data as a sequence of 14 bytes...

MSB/LSB(v_a) MSB/LSB(i_a) MSB/LSB(v_b) MSB/LSB(i_b)
MSB/LSB(T) MSB/LSB(intensity)error_A error B

TO DO: buffer readings and transmit everything using termination byte.
*/

void I2C_TransmitData(void)
{
  Wire.write(I2CData, 14);  
}

void I2C_PackI32(uint32_t data, uint16_t index)
{ 
  //pack time into bytes
  uint16_t i;
  uint16_t j;
  for (i = index, j = 3; i < 4; i++, j--)
  {
    I2CData[i] = data >> (j * 8);
  }
}

void I2C_PackI16(uint16_t data, uint16_t index)
{ 
  //pack time into bytes 
  I2CData[index] = data >> (j * 8);
  I2CData[index++] = data >> (j * 8);
}

void I2C_PrepareData(uint8_t data[])
{
  uint16_t Temp = TSense.raw_data;
  uint16_t Intensity = analogRead(LdrPin);
  uint32_t tTransmit = 0.5 * (LTChannelA.timer + LTChannelB.timer);
  
  //pack time into bytes
  int i;
  int j;
  for (i = 0, j = 3; i < 4; i++, j--)
  {
    I2CData[i] = tTransmit >> (j * 8);
  }
  
  //convert unsigned ints into two byte strings
  I2CData[0] = LTChannelA.IVData.v >> 8;
  I2CData[1] = LTChannelA.IVData.v;

  I2CData[2] = LTChannelA.IVData.iTransmit >> 8;
  I2CData[3] = LTChannelA.IVData.iTransmit;

  I2CData[4] = LTChannelB.IVData.v >> 8;
  I2CData[5] = LTChannelB.IVData.v;

  I2CData[6] = LTChannelB.IVData.iTransmit >> 8;
  I2CData[7] = LTChannelB.IVData.iTransmit;

  I2CData[8] = Temp >> 8;
  I2CData[9] = Temp;
  
  I2CData[10] = Intensity >> 8;
  I2CData[11] = Intensity;

  I2CData[12] = LTChannelA.error;
  I2CData[13] = LTChannelB.error;
}
